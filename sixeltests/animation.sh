#!/bin/bash

# Test of Sixel palette animation.
cleanup() {
  echo ${ST}
  set_cursor_pos 1 1
  echo -n ${CSI}'2J'
  echo -n ${CSI}'?25h'
  reset_palette
  select_status_line_type default
}

trap cleanup EXIT

CSI=$'\e['			# Control Sequence Introducer 
DCS=$'\eP'			# Device Control String
ST=$'\e\\'			# String Terminator

echo -n ${CSI}'!p'
echo -n ${CSI}'H'
echo -n ${CSI}'J'
echo -n ${CSI}'?7h'
echo -n ${CSI}'?25l'

set_cursor_pos() {
  echo -n ${CSI}${1}';'${2}'H'
}

draw_ball() {
  echo '#15!62?GGGKK]]!12~!13}{{{wwwoo___#14$!47?!5W!4C!16?_#13$!44?!4_OOOGGCCC!6W!6O!4_#6$!36?!4_!4O!4G!4C!4?!5o!6?_#1$!42?__??O!17?___#11$!48?!8_!6?__#9$!50?___OKK!5?G#2$!41?_???O???G?C!9?_#3$!60?_#4$!40?_???O???G!9?__#5$!57?_O#7$!55?c?O#8$!52?__oOO#10$!49?_??O?G#12$!47?_???O?G-'
  echo '#15!75?!33~}}}{{wo_#4$!31?!5y!39~!7w?O?_#14$!37?!9r!11?!6}!7@?!4B?A?CgggO?_#2$!33?AAA_ppp!11?__ooKKKAA@@@!6?AA!6?s?G?O?_#3$!35?_O!13G_?O?GC?A?@!16?o!4?G_#12$!35?!4C!4A```!15?www!5M!4?AAA!5?_#13$!23?_OOGCCAAA!6?A??``_!14?__oWKEB!5@??F!4C???_#5$!30?_?OGC!12?O?G?C?A?@!13?@!4?wA??G?O#6$!29?_?OHD@@!7?!4WKKCCAA?@!13?@??www??C??O#1$!34?AAA?`pO!13?_ooWKEEB@!8?@!6?o#8$!27?ooWWKC!9?!4KEEBBB@@@!12?@@?{{??@A??G#9$!26?_O?GCA!7?GGGCCCAA@@!18?{{K!5?CG#11$!24?__OGGCA!5?!4CEEAA@@@!16?_oWCAA!5?C#7$!30?O!11?O??G?C??A??@!13?@??o[#10$!25?_??G!9?G??C??A?@!18?_wKA-'
  echo '#15!88?!29~}{wwo_#11$!15?oooKKK!67~???CGO_#14$!33?!7~!14?!7B!19?}}}!7?CGO_#2$!29?!4{FFF@@@!10?!7@!8?!16~!11?O_#4$!24?!5{NNBB!25?!6o!10?~~~!10?@EEO_#5$!23?_OG?CA@!26?wwW!13?~~F!12?ACW_#3$!27?_oOGCA@@!25?_ooo!12?~o!12?G#7$!20?oooGGEE@@!22?!5{!12?!4~!15?C?_#8$!19?_OOGEEA@!21?{{{[C!13?{{^@!15?@Eww#6$!22?_OG?CA@!24?_wwG!13?_~^!15?G#9$!18?_O?GCA?@!19?oo{]E!4A!10?[[NB!16?@EW_#10$!16?_oOGKCA?@!18?_oWKA@!13?W]NB!17?@EW_#12$!38?ooWKEB@!13?EEB@!19?@EW_#13$!13?__OGGCAA@@!12?_ow[MFB@!12?CEFB@!20?@Mw_#1$!31?_oWKCAB@!12?AAB@@!22?@~o-'
  echo '#15!96?!28~}{wo#11$!18?!78~??O_#14$!15?{{{!9?!9^!30?!7}!8?!4^!12?O_#10$!14?!7@o!5w!11?_oWK!25F!9?!6w!4?@F[!7xACG#12$!17?_W!10C!4?ooWKEB@!31?{{[!10?BMw_!6?@ACG#2$!12?{{{!9A!4MBBB!30?!5~!12?NNN!14?WW_#3$!11?_WMA!8?CCA@@!29?!4~NB!13?FF!15?EE?_#1$!13?_oK!9A?GKCAB@!32?w}^B!11?@NK!11?@ACG#5$!20?!5B!27?!5~@@@!12?!4B!15?BBKoo#4$!10?_WE@!6?CEEBB@!29?_w]F@!14?BB!16?@?GO#6$!9?_WE@!6?A?@!7?!4_!16?{{{^NB!15?@@!12?__!4?@ACO_#7$!17?AA@@!5?___!18?ww[FB!16?@@!12?__!7?CW_#8$!18?@!5?ooO!16?!4}NFB!30?oo!6?BBMw_#9$!17?@!5?oO!15?_ow]NF@!31?oo!8?ACO#13$!16?_WC!11?ow{]NFB@!31?w}E!10?@N[O-'
  echo '#15!101?!28~{o#3$!8?!93~!4?_#10$!17?!17~??!20B!19?!15~!7@???sssGO#5$!29?!5~!16?!4~@@@!29?~~~!7?B!5C??_#12$!13?!4~@@@!29?_!19?!6~!23?w??CGO#7$!23?!6~!15?!6N!32?!4~!8?BB!7?_#8$!21?ww]F@!16?FFF@!34?~~!10?BB!8?o#11$!15?_w]F@!14?@@@!35?o~~!13?@!10?o@A#9$!19?_w[F@!15?ABB@!34?}~~!11?@!9?o#1$!10?wwFFF!25?{{ww!17?!8~!24?!4{??EEG#14$!11?_WMBB!27?_!5o!15?_{~~~!26?[__?@A#2$!9?oGE@!24?o{{K!17?o{~^B!29?{_!4?@CG#4$!7?oKB!21?_w}]E!16?_w]F@!31?}}!7?AC#13$!12?_OKB!30?ooo!18?w~^@!25?Ww#6$!6?oKB!17?_w}^F@!15?[]^F@!32?~~!9?BC-'
  echo '#15!106?!26~w_#3$!5?!101~Eo#5$!26?!5~!37?!22~!14?@Eo#4$!4?WE@!21?_w}^F@!37?!16_?F~w!15?G#7$!20?!6~!36?!6o!14?!4~!18?Eo#6$???WE@!17?_w}^F@!36?ooo!16?~~{!18?G#8$!18?ww]F@!36?{{{W!16?~~~!21?Fw#9$!5?!11_ww]F@!34?!4}K!16?~~~!23?Nw#10$!4?_!8?{{{NF@!33?~~~]E!17?~~F!24?No#11$???_!8?_WEB!34?{{NB!17?W~~B!25?No#12$!10?{{]F@!32?~~~NB!16?^^^F!27?No#13$??_!6?oKA@!30?!4~F@!16?G^^F!28?~~o#14$!8?oKA@!28?}}}^B!18?NNF!30?^w#1$!6?wwMB@!26?~~~^F@!17?AFFB!30?~~_#2$!6?WE@!25?o{~NB!18?@BB@!32?~_-'
  echo '#15!109?!25~}w#4$!10?!99~_#1$!16?!10w!8?!35~!9?!11{!6?!12~?@W#6$!7?~~~!11?!5^!37?!6~!15?!5N!17?@K_#5$!8?_}]!13?W]F@!38?_}~^@!16?^^!18?QQ#3$!12?!4{!12?_w}!4N!38?{!4}!13?!4~!13?A#7$!6?wN!11?NNF@!37?~~~N!18?FF!22?Mo#8$!5?wF!10?FF@!36?!4~^B!17?BFF!23?Fo#9$!4?wF!8?FFF@!35?~~~^F!18?BBB!24?^^w#10$???oF!7?BBB!35?~~~NB!19?@@!15?_!10?@M_#11$??oN!8?@!12?_!21?~~~F@!37?__!10?F}o#12$!9?@@@!11?__!19?~~~NB!38?__!11?Bw#13$?oN!18?__!18?~~~NB!38?woo!11?~~{#14$!18?woo!16?_w}~F@!38?_ww!13?^{#2$!14?ww!15?o{~^F@!38?w}{K!14?B~_-'
  echo '#15!111?!25~#1$!15?!96~K_#11$??!13~!9?!9~!11?!32~!12?!8~!6?!8F?_#4$!9?!6~!29?_!23?!8~!27?!5w?@KO#13$?~!17?!5~!15?!6N!37?!6~!12?BB!8?_#6$!6?~~~!29?ww!4o!17?!7~!31?!4{!5?@KO#14$!17?}~^@!15?AFFB!40?w~N!15?BB!9?_#7$!5?wN!28?{{wW!19?~~~N@!34?{{[!7?@MO#5$!8?~^!32?__!20?_{~~B!33?w!6?A#8$!4?wF!26?{{{K!18?!4~N@!35?}}]!9?EO#9$???wF!24?}}}[!18?~~~^B!37?}}M!9?NNG#2$!13?~~!15?@BB@!39?~~~^B!16?@@!10?oo#10$???F!23?w}M!17?_w~~N@!37?w~~F!10?BG#3$!11?~~!15?@@!41?w~N@!30?o#12$!22?{~F!17?W]NB!39?_}~B!13?E-'
  echo '#15!112?!23~B#8$???!109~F#11$?~~!20?!8~!35?!28~!16?oN#10$??CC!22?}!4~!17?!6@!35?w!4~!17?O#13$]@!16?!5~!36?!7w!15?!5~!23?wF#12$?A!18?_~~F!39?ooo!18?o~^!23?G#14$!16?~~N!37?{{{W!18?~~~F!26?{F#1$!14?~~@!35?!4{K!18?~~~N!28?{B#2$!12?~~!35?}}}K!19?~~~F!29?~~B#3$!10?~~!34?~~}E!19?~~~B!31?}F#4$!8?~~N!31?!4~B!19?O~~^@!31?~~@#5$!7?w^!31?~~^@!19?G^^N!34?~B#6$_!4?~~F!29?~~~N!19?CNNF!34?~~~#7$!4?wN!27?_{~~F!19?AFFB!35?_~^#9$??wF!24?{~~F!18?@BB@!38?}~B-'
  echo '#15!111?!24~#8$!13?!98~F#11$!8?!5{!9?!8~!34?!9~!12?!7~!18?~#13$!5?}}}!9?!5^!35?!7~!16?!5N!23?~~#12$!7?Co!10?W~~F!37?_{~~F@!17?[^F!23?w#14$!4?AW!9?NNB!35?!4~N@!18?FFF@!26?{F#1$???B[_!7?NN@!34?~~~^F!19?AFFB!28?{B#2$??B[_!6?FF!34?~~~^B!19?BBB@!30?~B#3$!10?F!33?~~~N@!20?@@!32?~~#4$?@K_!4?BB!31?~~~F!40?_!16?~@#5$AA!5?B!11?_!18?~~~B!41?__!15?~~#6$@Mo??@@!10?__!16?~~~^@!39?wwoo!14?~~~#7$!4?@!10?oo!15?w~~N!40?_wwW!15?_~^#9$!11?ww!13?!4~B!38?}}}{K!16?~~^@#10$!10?W!13?o~^@!39?o{]E!17?w~N-'
  echo '#15!110?!23~NB#11$!9?!101~B#8$!14?!25~!31?!30~!5?!4_?C#12$!8?@K_!26?__!19?~~~^B!35?ooO!7?wB#13$!7?F}o!24?www!18?~~~N@!35?www!9GwF#14$!6?Bw!23?{{{!17?!4~F!37?ww[!10C{F#1$!5?B[!22?{{!18?~~^B!37?}}}[C!10?[B#2$!4?B[_!19?}}}!16?!4~B!37?}}}]E!12?^B#9$!12?~~o!11?@BB!38?~~~^F!18?@@!11?__#10$!11?Fo!11?@@!38?o{~NB!32?_oO#3$!24?}}!16?~~~^@!38?ww]F@!12?NN#4$???@C_!16?~~!15?O~~^@!38?}}}^F@!13?N@#5$!4?W!14?~~~!15?^^N!40?{{^F@!14?NN#6$??@]_!12?~~o!14?CNNF!38?!4~NB!15?FF#7$!15?@~}!13?AFFB!38?_w}^F@!16?BB-'
  echo '#15!107?!23~^B#4$!6?!101~WE@#5$!5?ZZ!15~{!32?!4o!18?{{^F@!23?oWE@#6$!4?B[_!11?~~!32?wwwO!18?~~~NB!25?oGE@#7$!16?~~}!30?{{{W!17?!4~NB!26?ooKF@#8$!15?F}!30?{{K!18?}}^F@!28?_WKB#9$!13?~~w!28?~~~E!16?!4~N@!30?oWEB#10$!12?B{!27?~~~B!16?~~~^F!32?wwMF@#11$!11?B{!25?~~~F!17?[[NB!34?o[E@#12$!10?B{!24?~~F!17?G^^NB!33?{{{NB@#13$!9?F{!22?~~~B!16?CNNF@!34?ww]FB#14$!8?Fw!21?~~^!16?AFFB!36?ww]F@#1$!7?BW!20?~~!17?BB@!36?}}}^F@#2$!6?B[_!17?~~~!17?@@!36?}}}^F@#3$!24?F~o!34?_!20?_w]F@-'
  echo '#15!104?!23~^F@#4$!14?!90~KB#5$!12?UUU!8n!29?!4~NB!17?NNF@!22?wwKB#6$!11?ACG_!4?NN!29?}}^F@!17?FFFB!24?_WCB#7$!10?ACGO???FFE!27?~~~N@!17?FFFB!26?_WEB#8$!12?O_??@E!27?~~N@!18?BB@!27?oo[E@#9$!8?BBCG???FE!25?~~~F!19?@@!14?!16_OKB@#10$!14?B!25?~~N!36?__!14?_WMB#11$!11?O_B!10?!14_~~B!35?___!14?ww]F@#12$!7?@ACG?@!8?oo_!11?~~^!35?oooO!14?wwMF@#13$!6?@ACGO`!9?_!11?~~N!34?wwwWG!14?wwMF@#14$!10?@!7?wwo!10?~~!34?{{{WG!15?ww]F@#1$!9?@!7?Go!10?~~!33?{{{[C!15?}}}^F@#2$!16?Go!9?~~!32?}}}^MA!15?}}^F@#3$!14?CGo!8?~~!31?_w}^F@!16?W]F@-'
  echo '#15!100?!21~^NFFB@#4$!17?!83~WE@#5$!16?HHH!16Oww!12?!4~NB!31?_WWK!8C[[F@#11$!13?BBB!8?!11~??!14F!20?!15~!5?!8F_#6$!15?@AC!15?{{!12?ww^F@!31?oooWKC!9?KB#12$!14?KKooo???FFMw_!8?FF!31?www[NF@!15?BB!5?__#7$!17?GO_!11?}}o!11?}}^F!32?__WWKEAAA!7?KB#13$!12?@EGO_!5?AGO!8?BB!31?ww[MFB!16?BB!6?_O#8$!14?@AC!12?]]w!11?^^N@!32?oo[[MEA!9?MMB#14$!20?FFKo_!6?@@!30?{{{^FB@!17?@@!6?_O#9$!15?CGO_!8?NN{_!10?NNF!31?www{]NFB!4@!8?E@#10$!25?@F[o!10?MNB!31?_oWKEB@!14?E@#1$!19?@EGO!6?@@!12?__!16?{{MFB!18?@@@!6?ooO#2$!18?@A?O_!18?oo!15?}}}NB@!28?_OG#3$!17?@ACW_!17?oo!14?_w}NB@!30?_OG-'
  echo '#15!91?!23~^NFBB@#11$!18?BB!9F!62~?OG?CA?@#12$!26?@EW!17?}}}^E!13A[[[NF@!19?_OOGEEA@@#13$!17?@AC!5?@EW!17?o[F@!14?MMFB!21?_O?GCA?@#14$!24?BEW!16?}}NB!13?NNNF@!21?__OKKCA@@#1$!23?@?G!16?}N@!14?FF@!23?_OOGCBB@#2$!24?C!15?~~@!13?FFF@!24?_O?GCA@#3$!22?HEW?!4_!8?~~@!13?BBB!26?_O?GCA@#4$!21?@AG!13?~F!13?BB@!25?wwwWMMFB@#5$!22?C!6?_!5?~~!13?@@!11?___!13?_OGEEB@#6$!20?HIOO__??_!5?N{!25?ooO!12?oooWKEB@#7$!32?^^o!23?oooO!12?__WWKEB@#8$!19?@AC!9?B]_!22?ooWG!13?_WWKEB@#9$!30?F[_!20?wwwWG!12?www[MFB@#10$!25?O?_@FW_!19?_oWKC!12?_oWKEB@-'
  echo '#15!80?!22~^^^NNFFBB@#11$!37?!43~!4?GC?A@#13$!35?EEG!5?NNN!19?oooWWWKKK!9CGCAA@#14$!42?CB!18?___OO?GGCC!8AKKKEA@@#12$!44?GMF@!19?_??O??G?!7C!4?A#1$!34?A???O??EB!6?!13_??O??G?C?A!9?C??@#2$!32?!4D???FF@!5?__!11?_?OOKKKEEAA!9?C?A@#4$!37?BB!6?!10O!5w!4M!4B!8?!4FBBO#3$!28?!4BEEWWW?b!5?___!11?__OOGGCCAB!11@C?A@#6$!26?@@AADDIGPP__!4?oo!9?oo!4M!4B!11?BBB??_?O#7$!33?DDGGO?___G!7?oooWKFFB@!14?@@___oOO#9$!40?WW!6?[[[FFF@@!13?!4@__??O?G#10$!29?@?A!6?CG_!5?OWKEB@!20?_???O?G#5$!31?@??C?J!6?_O!9?_OOGKCEBB@@!11?A@@#8$!33?@!7?W!8?OGKCA@!16?@-'
  echo '#15!68?!13F!12NFFBB@@@#6$!38?!6@!8A!11CG???C???A???@#7$!40?!5@!8A!4C!5?G??CC?AAA?@@@#8$!55?!13A???@#9$!61?!4CAAA?@@#10$!54?A!5?C???A???@#11$!47?!7A!9?A??@@#12$!52?!10@A??@#13$!51?@!8?II?@@#14$!45?!6@!6?AAA@@@#1$!56?A??@G#3$!42?@@@!11?@@@C#2$!44?@!5?CC!4?GGHG#5$!41?@!16?C#4$!53?@@@-'
}

update_palette() {
  local step=${1}
  local dir=${2}
  local i

  for i in {0..13}
  do
    local cn=$((i+1))
    local rgb=$(((i+step)%14))
    if [[ $dir == 1 ]]
    then
      if [[ ${rgb} -lt 1 ]]; then rgb='100;86;86'
      elif [[ ${rgb} -lt 7 ]]; then rgb='100;100;100'
      else rgb='100'
      fi
    else
      if [[ ${rgb} -lt 6 ]]; then rgb='100;100;100'
      elif [[ ${rgb} -lt 7 ]]; then rgb='100;86;86'
      else rgb='100'
      fi
    fi
    echo -n "#${cn};2;${rgb}"
  done
}

bounce_ball() {
  local step=0
  local dir=1
  local start_row=${1}
  local i=$((start_row-1))
  while true
  do
    echo -n ${DCS}';1q'
    update_palette ${step} ${dir}
    echo -n ${ST}

    #    read -sn 1 -t 0.4 && break
    read -s -n1 -t 0.04 2>/dev/null && break

    if [[ ${i} -lt 19 ]]
    then
      echo -n $'\033[H\033[L'
      dir=1
    else
      echo -n $'\033[H\033[M'
      dir=-1
    fi

    step=$(((step+dir+14)%14))
    i=$(((i+1)%38))    
  done
}

spin_ball() {
  local step=0
  while true
  do
    update_palette ${step} 1
    read -sn 1 -t 0.01  2>/dev/null  && break
    step=$(((step+1)%14))
  done
}

reset_palette() {
  echo ${DCS}';1q'
  for i in {1..14}
  do
    echo "#${i};2;46;46;46"
  done
  echo "#15;2;79;79;79"
  echo "#0;2;0;0;0"
  echo ${ST}
}

select_status_line_type() {
  local Ps
  case "$1" in
      none|0) 
	  Ps=0
	  ;;
      host-writable|2)
	  Ps=2
	  ;;
      *|default|1)
	  Ps=1
	  ;;
  esac
  echo -n ${CSI}${Ps}'$~'
}


# Main starts here

select_status_line_type none

set_cursor_pos 10 35

echo ${DCS}'9;1q'
update_palette 0 1
echo "#15;2;40;40;40"
echo "#0;2;66;66;66"
draw_ball

case "$1" in
    spin) spin_ball
	     ;;
    bounce|*) bounce_ball 10
	      ;;
esac

